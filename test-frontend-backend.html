<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend Integration Test - Frontend</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .vehicle-card {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .loading {
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>üß™ Backend Integration Test - Frontend</h1>
    <p>Testing data retrieval and display from MongoDB through the API</p>

    <div class="container">
        <h2>üìä API Status</h2>
        <div id="api-status" class="loading">Checking API status...</div>
        <button onclick="checkApiStatus()">Refresh Status</button>
    </div>

    <div class="container">
        <h2>üöó Vehicle Data</h2>
        <div id="vehicle-stats" class="stats"></div>
        <div id="vehicle-list"></div>
        <button onclick="loadVehicles()">Load Vehicles</button>
        <button onclick="testVehicleActions()">Test Actions</button>
    </div>

    <div class="container">
        <h2>üë• User Data</h2>
        <div id="user-stats" class="stats"></div>
        <div id="user-list"></div>
        <button onclick="loadUsers()">Load Users</button>
    </div>

    <div class="container">
        <h2>üîß Action Button Tests</h2>
        <div id="action-tests"></div>
        <button onclick="runActionTests()">Run Action Tests</button>
    </div>

    <script>
        let testVehicleId = null;

        async function checkApiStatus() {
            const statusDiv = document.getElementById('api-status');
            statusDiv.innerHTML = '<span class="loading">Checking API status...</span>';
            
            try {
                const response = await fetch('http://localhost:3001/api/health');
                if (response.ok) {
                    const data = await response.json();
                    statusDiv.innerHTML = `
                        <span class="success">‚úÖ API is running</span><br>
                        <strong>Status:</strong> ${data.status}<br>
                        <strong>MongoDB:</strong> ${data.mongodb}<br>
                        <strong>Timestamp:</strong> ${new Date(data.timestamp).toLocaleString()}
                    `;
                } else {
                    statusDiv.innerHTML = `<span class="error">‚ùå API returned status: ${response.status}</span>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<span class="error">‚ùå API connection failed: ${error.message}</span>`;
            }
        }

        async function loadVehicles() {
            const statsDiv = document.getElementById('vehicle-stats');
            const listDiv = document.getElementById('vehicle-list');
            
            statsDiv.innerHTML = '<span class="loading">Loading vehicle statistics...</span>';
            listDiv.innerHTML = '<span class="loading">Loading vehicles...</span>';
            
            try {
                const response = await fetch('http://localhost:3001/api/vehicles');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const vehicles = await response.json();
                
                // Calculate statistics
                const totalVehicles = vehicles.length;
                const publishedVehicles = vehicles.filter(v => v.status === 'published').length;
                const soldVehicles = vehicles.filter(v => v.status === 'sold').length;
                const featuredVehicles = vehicles.filter(v => v.isFeatured).length;
                const certifiedVehicles = vehicles.filter(v => v.certificationStatus === 'certified' || v.certificationStatus === 'approved').length;
                
                statsDiv.innerHTML = `
                    <div class="stat-card">
                        <h3>${totalVehicles}</h3>
                        <p>Total Vehicles</p>
                    </div>
                    <div class="stat-card">
                        <h3>${publishedVehicles}</h3>
                        <p>Published</p>
                    </div>
                    <div class="stat-card">
                        <h3>${soldVehicles}</h3>
                        <p>Sold</p>
                    </div>
                    <div class="stat-card">
                        <h3>${featuredVehicles}</h3>
                        <p>Featured</p>
                    </div>
                    <div class="stat-card">
                        <h3>${certifiedVehicles}</h3>
                        <p>Certified</p>
                    </div>
                `;
                
                // Display first 5 vehicles
                const displayVehicles = vehicles.slice(0, 5);
                listDiv.innerHTML = displayVehicles.map(vehicle => `
                    <div class="vehicle-card">
                        <h4>${vehicle.year} ${vehicle.make} ${vehicle.model}</h4>
                        <p><strong>Price:</strong> ‚Çπ${vehicle.price.toLocaleString()}</p>
                        <p><strong>Status:</strong> ${vehicle.status}</p>
                        <p><strong>Featured:</strong> ${vehicle.isFeatured ? 'Yes' : 'No'}</p>
                        <p><strong>Certification:</strong> ${vehicle.certificationStatus || 'none'}</p>
                        <p><strong>Views:</strong> ${vehicle.views || 0}</p>
                        <p><strong>Seller:</strong> ${vehicle.sellerEmail}</p>
                        <p><strong>Location:</strong> ${vehicle.city}, ${vehicle.state}</p>
                    </div>
                `).join('');
                
                // Store first vehicle ID for action tests
                if (vehicles.length > 0) {
                    testVehicleId = vehicles[0].id;
                }
                
            } catch (error) {
                statsDiv.innerHTML = `<span class="error">‚ùå Failed to load vehicles: ${error.message}</span>`;
                listDiv.innerHTML = `<span class="error">‚ùå Failed to load vehicles: ${error.message}</span>`;
            }
        }

        async function loadUsers() {
            const statsDiv = document.getElementById('user-stats');
            const listDiv = document.getElementById('user-list');
            
            statsDiv.innerHTML = '<span class="loading">Loading user statistics...</span>';
            listDiv.innerHTML = '<span class="loading">Loading users...</span>';
            
            try {
                const response = await fetch('http://localhost:3001/api/users');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const users = await response.json();
                
                // Calculate statistics
                const totalUsers = users.length;
                const activeUsers = users.filter(u => u.status === 'active').length;
                const sellers = users.filter(u => u.role === 'seller').length;
                const customers = users.filter(u => u.role === 'customer').length;
                const admins = users.filter(u => u.role === 'admin').length;
                
                statsDiv.innerHTML = `
                    <div class="stat-card">
                        <h3>${totalUsers}</h3>
                        <p>Total Users</p>
                    </div>
                    <div class="stat-card">
                        <h3>${activeUsers}</h3>
                        <p>Active</p>
                    </div>
                    <div class="stat-card">
                        <h3>${sellers}</h3>
                        <p>Sellers</p>
                    </div>
                    <div class="stat-card">
                        <h3>${customers}</h3>
                        <p>Customers</p>
                    </div>
                    <div class="stat-card">
                        <h3>${admins}</h3>
                        <p>Admins</p>
                    </div>
                `;
                
                // Display users
                listDiv.innerHTML = users.map(user => `
                    <div class="vehicle-card">
                        <h4>${user.name}</h4>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Role:</strong> ${user.role}</p>
                        <p><strong>Status:</strong> ${user.status}</p>
                        <p><strong>Mobile:</strong> ${user.mobile || 'N/A'}</p>
                        <p><strong>Verified:</strong> ${user.isVerified ? 'Yes' : 'No'}</p>
                        <p><strong>Plan:</strong> ${user.subscriptionPlan || 'free'}</p>
                    </div>
                `).join('');
                
            } catch (error) {
                statsDiv.innerHTML = `<span class="error">‚ùå Failed to load users: ${error.message}</span>`;
                listDiv.innerHTML = `<span class="error">‚ùå Failed to load users: ${error.message}</span>`;
            }
        }

        async function testVehicleActions() {
            if (!testVehicleId) {
                alert('Please load vehicles first to get a test vehicle ID');
                return;
            }
            
            const actionsDiv = document.getElementById('action-tests');
            actionsDiv.innerHTML = '<span class="loading">Testing vehicle actions...</span>';
            
            const actions = [
                { name: 'Refresh', action: 'refresh', refreshAction: 'refresh' },
                { name: 'Renew', action: 'refresh', refreshAction: 'renew' },
                { name: 'Feature', action: 'feature' },
                { name: 'Certify', action: 'certify' },
                { name: 'Mark as Sold', action: 'sold' }
            ];
            
            let results = [];
            
            for (const action of actions) {
                try {
                    const payload = {
                        action: action.action,
                        vehicleId: testVehicleId
                    };
                    
                    if (action.refreshAction) {
                        payload.refreshAction = action.refreshAction;
                        payload.sellerEmail = 'seller1@test.com'; // Use a known seller email
                    }
                    
                    const response = await fetch('http://localhost:3001/api/vehicles', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        results.push(`<span class="success">‚úÖ ${action.name}: Success</span>`);
                    } else {
                        results.push(`<span class="error">‚ùå ${action.name}: Failed (${response.status})</span>`);
                    }
                } catch (error) {
                    results.push(`<span class="error">‚ùå ${action.name}: Error - ${error.message}</span>`);
                }
            }
            
            actionsDiv.innerHTML = results.join('<br>');
        }

        async function runActionTests() {
            await testVehicleActions();
        }

        // Initialize on page load
        window.onload = function() {
            checkApiStatus();
            loadVehicles();
            loadUsers();
        };
    </script>
</body>
</html>
