<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Chat Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .chat-widget { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            width: 350px; 
            height: 500px; 
            border: 1px solid #ddd; 
            border-radius: 10px; 
            background: white; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
        }
        .chat-header { 
            background: #007bff; 
            color: white; 
            padding: 15px; 
            border-radius: 10px 10px 0 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .chat-messages { 
            flex: 1; 
            padding: 15px; 
            overflow-y: auto; 
            background: #f8f9fa;
        }
        .message { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 10px; 
            max-width: 80%;
        }
        .message.user { 
            background: #007bff; 
            color: white; 
            margin-left: auto; 
        }
        .message.seller { 
            background: white; 
            border: 1px solid #ddd; 
        }
        .chat-input { 
            padding: 15px; 
            border-top: 1px solid #ddd; 
            display: flex; 
            gap: 10px;
        }
        .chat-input input { 
            flex: 1; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .chat-input button { 
            padding: 10px 15px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Simple Chat Test</h1>
    
    <div class="test-section">
        <h2>Test Chat Functionality</h2>
        <button onclick="openChat()">Open Chat Widget</button>
        <button onclick="addTestMessage()">Add Test Message</button>
        <button onclick="checkConversations()">Check Conversations</button>
        <div id="result"></div>
    </div>

    <!-- Simple Chat Widget -->
    <div id="chatWidget" class="chat-widget">
        <div class="chat-header">
            <span>Chat with Seller</span>
            <button onclick="closeChat()" style="background: none; border: none; color: white; font-size: 18px; cursor: pointer;">×</button>
        </div>
        <div id="chatMessages" class="chat-messages">
            <div class="message seller">
                <strong>Seller:</strong> Hello! How can I help you with this vehicle?
            </div>
        </div>
        <div class="chat-input">
            <input type="text" id="messageInput" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        const CONVERSATION_STORAGE_KEY = 'reRideConversations';
        
        function openChat() {
            document.getElementById('chatWidget').style.display = 'flex';
            loadMessages();
        }
        
        function closeChat() {
            document.getElementById('chatWidget').style.display = 'none';
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            
            // Add message to chat
            addMessageToChat('user', message);
            input.value = '';
            
            // Save to localStorage
            saveMessageToConversation(message);
            
            // Simulate seller response
            setTimeout(() => {
                const responses = [
                    "Thanks for your message! Let me get back to you shortly.",
                    "I'll check the details and respond soon.",
                    "Great question! Let me provide you with more information.",
                    "I'm here to help! What else would you like to know?"
                ];
                const response = responses[Math.floor(Math.random() * responses.length)];
                addMessageToChat('seller', response);
                saveMessageToConversation(response, 'seller');
            }, 1000);
        }
        
        function addMessageToChat(sender, text) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            messageDiv.innerHTML = `<strong>${sender === 'user' ? 'You' : 'Seller'}:</strong> ${text}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function saveMessageToConversation(text, sender = 'user') {
            try {
                let conversations = JSON.parse(localStorage.getItem(CONVERSATION_STORAGE_KEY) || '[]');
                
                // Find or create conversation
                let conversation = conversations.find(c => c.id === 'conv_test_simple');
                if (!conversation) {
                    conversation = {
                        id: 'conv_test_simple',
                        customerId: 'test@example.com',
                        customerName: 'Test User',
                        sellerId: 'seller@test.com',
                        vehicleId: 1,
                        vehicleName: 'Test Vehicle',
                        vehiclePrice: 1000000,
                        messages: [],
                        lastMessageAt: new Date().toISOString(),
                        isReadBySeller: false,
                        isReadByCustomer: true,
                        isFlagged: false
                    };
                    conversations.push(conversation);
                }
                
                // Add message
                conversation.messages.push({
                    id: Date.now(),
                    sender: sender,
                    text: text,
                    timestamp: new Date().toISOString(),
                    isRead: false,
                    type: 'text'
                });
                conversation.lastMessageAt = new Date().toISOString();
                
                // Save back to localStorage
                localStorage.setItem(CONVERSATION_STORAGE_KEY, JSON.stringify(conversations));
                
                console.log('✅ Message saved to conversation:', conversation);
            } catch (error) {
                console.error('❌ Error saving message:', error);
            }
        }
        
        function loadMessages() {
            try {
                const conversations = JSON.parse(localStorage.getItem(CONVERSATION_STORAGE_KEY) || '[]');
                const conversation = conversations.find(c => c.id === 'conv_test_simple');
                
                if (conversation && conversation.messages.length > 0) {
                    const messagesDiv = document.getElementById('chatMessages');
                    messagesDiv.innerHTML = '';
                    
                    conversation.messages.forEach(msg => {
                        addMessageToChat(msg.sender, msg.text);
                    });
                }
            } catch (error) {
                console.error('❌ Error loading messages:', error);
            }
        }
        
        function addTestMessage() {
            const testMessages = [
                "Hi, is this vehicle still available?",
                "What's the best price you can offer?",
                "Can I schedule a test drive?",
                "What's the vehicle's condition?",
                "Do you have more photos?"
            ];
            
            const randomMessage = testMessages[Math.floor(Math.random() * testMessages.length)];
            addMessageToChat('user', randomMessage);
            saveMessageToConversation(randomMessage);
            
            document.getElementById('result').innerHTML = `
                <div class="success">
                    <h3>✅ Test Message Added!</h3>
                    <p>Message: "${randomMessage}"</p>
                </div>
            `;
        }
        
        function checkConversations() {
            try {
                const conversations = JSON.parse(localStorage.getItem(CONVERSATION_STORAGE_KEY) || '[]');
                document.getElementById('result').innerHTML = `
                    <div class="success">
                        <h3>✅ Conversations Found!</h3>
                        <p>Total conversations: ${conversations.length}</p>
                        <pre>${JSON.stringify(conversations, null, 2)}</pre>
                    </div>
                `;
            } catch (error) {
                document.getElementById('result').innerHTML = `
                    <div class="error">
                        <h3>❌ Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Auto-check on page load
        window.onload = function() {
            checkConversations();
        };
    </script>
</body>
</html>
